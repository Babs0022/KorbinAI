rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is the owner of a document.
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Admins can read and write anything.
    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // AUTHENTICATION
    // Users collection can be read by anyone but only written by the owner or an admin.
    match /users/{userId} {
      allow read;
      allow write: if isOwner(userId) || isAdmin();
    }

    // Admins can read and write to the admins collection.
    match /admins/{adminId} {
      allow read, write: if isAdmin();
    }

    // CHAT SESSIONS
    match /chatSessions/{chatId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(request.resource.data.userId);
    }
    
    // PROJECTS & GENERATIONS
    // Users can only access their own projects and generations.
    match /projects/{projectId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(request.resource.data.userId);
    }
    match /generations/{generationId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(request.resource.data.userId);
    }

    // SUBSCRIPTIONS
    // Users can only read their own subscription status.
    // Writes are handled by secure Cloud Functions.
    match /userSubscriptions/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isAdmin(); // Only allow admins/backend to write
    }

    // TRANSACTIONS
    // Users can read their own transactions. Writes are handled by secure Cloud Functions.
    match /transactions/{transactionId} {
        allow read, write: if isOwner(resource.data.userId) || isAdmin();
        allow create: if isOwner(request.resource.data.userId) || isAdmin();
    }
    
    // VERIFICATION & FEEDBACK
    // Users can create verification requests and feedback, but not read others'. Admins can read/write.
    match /verificationRequests/{userId} {
        allow create: if isOwner(userId);
        allow read, write: if isAdmin();
    }
    match /userReports/{reportId} {
        allow create; // Any authenticated user can create a report
        allow read, write: if isAdmin();
    }
     match /feedback/{feedbackId} {
        allow create; // Any authenticated user can create feedback
        allow read, write: if isAdmin();
    }
  }
}
